#include <stdio.h>
#include <sys/time.h>
#include <c_wrapper.h>
#include <constants.h>

int main(int argc, const char* argv[]) {
    if (argc != 2) {
        fprintf(stderr, "usage: main <path-to-exported-script-module>\n");
        return -1;
    }

    float inputs[1][1][32][32] = {{{{-0.7872, -0.8048, -0.7971, -0.7946, -0.8272, -0.8116, -0.7991, -0.8104, -0.7979, -0.8095, -0.8111, -0.8282, -0.8327, -0.8111, -0.7653, -0.7839, -0.7698, -0.7900, -0.7931, -0.8036, -0.8185, -0.8337, -0.8163, -0.7906, -0.8085, -0.8063, -0.8036, -0.8191, -0.8051, -0.8000, -0.7968, -0.7910}, {-0.8019, -0.7957, -0.8038, -0.8145, -0.8074, -0.8247, -0.8069, -0.8200, -0.8250, -0.8018, -0.7840, -0.8267, -0.8554, -0.8110, -0.7607, -0.7773, -0.8034, -0.8305, -0.8654, -0.8684, -0.8303, -0.8111, -0.8257, -0.8324, -0.8215, -0.8004, -0.8363, -0.8067, -0.8432, -0.7895, -0.7906, -0.8044}, {-0.8035, -0.7926, -0.8227, -0.8120, -0.8114, -0.7901, -0.8243, -0.7992, -0.8276, -0.8127, -0.7745, -0.7815, -0.8227, -0.8115, -0.8371, -0.8303, -0.8453, -0.8310, -0.7997, -0.8032, -0.7914, -0.8376, -0.8828, -0.8081, -0.8310, -0.8329, -0.8058, -0.8213, -0.8099, -0.8161, -0.8078, -0.7856}, {-0.7938, -0.8323, -0.8131, -0.8159, -0.8033, -0.8144, -0.8166, -0.8336, -0.8242, -0.8215, -0.8124, -0.8714, -0.9076, -0.8943, -0.8440, -0.7897, -0.7930, -0.8135, -0.8443, -0.8977, -0.8635, -0.8019, -0.8235, -0.8279, -0.8521, -0.8030, -0.8184, -0.8023, -0.8185, -0.8142, -0.8252, -0.8006}, {-0.8203, -0.8038, -0.8259, -0.8034, -0.8103, -0.8024, -0.8632, -0.8141, -0.8336, -0.8830, -0.7980, -0.6843, -0.7406, -0.8113, -0.8282, -0.8337, -0.8103, -0.7828, -0.7552, -0.7582, -0.8082, -0.8783, -0.8825, -0.8052, -0.8165, -0.8517, -0.8096, -0.8242, -0.8139, -0.8243, -0.7992, -0.8277}, {-0.7900, -0.8252, -0.7960, -0.8151, -0.8144, -0.8449, -0.8010, -0.8294, -0.8243, -0.7887, -0.8367, -0.8080, -0.8402, -0.9176, -0.9285, -0.9222, -0.9230, -0.9269, -0.9423, -0.8982, -0.8037, -0.8033, -0.8277, -0.9238, -0.8479, -0.8342, -0.8617, -0.8119, -0.8142, -0.7955, -0.8183, -0.8079}, {-0.8197, -0.7958, -0.8260, -0.8165, -0.8441, -0.8292, -0.8569, -0.8566, -0.8284, -0.8503, -0.8908, -0.9604, -0.7341, -0.5240, -0.5119, -0.5140, -0.5443, -0.7023, -0.7609, -0.8528, -0.9611, -0.8957, -0.8173, -0.8311, -0.8678, -0.8781, -0.8136, -0.8650, -0.8102, -0.8291, -0.7882, -0.8002}, {-0.8023, -0.8186, -0.8328, -0.8474, -0.8110, -0.8424, -0.8636, -0.8191, -0.8500, -0.9104, -0.6561, -0.5033, -0.5977, -0.6220, -0.5436, -0.4983, -0.4258, -0.4569, -0.5740, -0.7606, -0.8094, -0.9019, -0.9858, -0.8492, -0.8542, -0.8589, -0.8483, -0.8351, -0.8521, -0.8016, -0.8091, -0.8222}, {-0.7818, -0.8192, -0.7919, -0.8311, -0.8206, -0.8973, -0.7908, -0.8444, -0.8463, -0.6994, -0.7110, -0.7087, -0.5534, -0.4433, -0.4643, -0.5433, -0.6499, -0.6547, -0.6910, -0.7322, -0.7730, -0.8787, -0.8886, -0.9119, -0.8429, -0.8477, -0.8425, -0.8313, -0.8239, -0.8288, -0.8140, -0.7981}, {-0.8215, -0.7988, -0.8666, -0.8192, -0.8800, -0.8033, -0.8379, -0.9248, -0.8350, -0.7336, -0.5057, -0.4118, -0.5031, -0.6246, -0.7188, -0.7248, -0.7152, -0.6661, -0.6698, -0.7242, -0.7874, -0.7816, -0.8770, -0.9030, -0.9039, -0.8566, -0.8255, -0.8896, -0.8279, -0.8066, -0.8269, -0.8222}, {-0.8132, -0.7941, -0.8335, -0.8252, -0.8596, -0.8065, -0.8806, -0.8996, -0.7404, -0.5767, -0.5622, -0.7356, -0.8236, -0.7517, -0.7453, -0.7583, -0.7630, -0.7775, -0.7343, -0.7346, -0.7884, -0.7286, -0.7387, -0.8739, -0.8772, -0.8733, -0.8412, -0.8522, -0.8308, -0.8112, -0.8091, -0.8244}, {-0.7954, -0.8447, -0.7909, -0.8574, -0.7819, -0.8318, -0.9588, -0.8049, -0.7222, -0.7479, -0.7833, -0.8161, -0.6611, -0.7307, -0.8193, -0.8046, -0.7811, -0.8074, -0.8046, -0.6665, -0.6595, -0.7227, -0.6343, -0.7532, -0.8693, -0.9165, -0.8463, -0.8200, -0.8582, -0.8155, -0.8460, -0.8115}, {-0.7853, -0.8658, -0.8032, -0.8912, -0.7761, -0.9074, -0.8946, -0.8378, -0.7853, -0.7830, -0.8159, -0.7507, -0.7832, -0.8791, -0.8448, -0.7439, -0.7405, -0.7736, -0.8777, -0.8224, -0.6258, -0.6513, -0.6416, -0.6133, -0.8495, -0.8912, -0.8723, -0.8326, -0.8792, -0.8264, -0.8593, -0.8202}, {-0.7898, -0.8452, -0.8299, -0.8404, -0.8080, -0.9578, -0.8512, -0.8155, -0.7749, -0.7866, -0.7960, -0.8077, -0.9175, -0.8176, -0.7798, -0.7758, -0.7661, -0.7505, -0.7767, -0.8697, -0.7436, -0.5784, -0.6459, -0.6258, -0.7817, -0.8621, -0.9105, -0.8266, -0.8675, -0.8308, -0.8199, -0.8181}, {-0.7990, -0.8275, -0.8348, -0.8051, -0.8376, -0.9763, -0.8318, -0.7532, -0.7625, -0.8179, -0.7964, -0.8508, -0.8435, -0.7779, -0.7806, -0.7867, -0.7812, -0.7799, -0.7690, -0.8394, -0.8212, -0.6314, -0.6445, -0.6328, -0.7025, -0.8646, -0.9372, -0.8356, -0.8455, -0.8387, -0.7984, -0.8103}, {-0.8042, -0.8140, -0.8485, -0.8036, -0.8266, -0.9474, -0.7776, -0.7484, -0.7859, -0.8313, -0.7987, -0.8882, -0.8306, -0.7860, -0.7857, -0.7872, -0.7887, -0.7868, -0.7841, -0.8170, -0.8404, -0.7227, -0.7258, -0.6671, -0.6275, -0.8334, -0.9419, -0.8411, -0.8169, -0.8406, -0.8136, -0.8118}, {-0.8034, -0.8135, -0.8356, -0.7879, -0.8501, -0.9170, -0.7959, -0.7742, -0.7949, -0.8269, -0.7881, -0.8807, -0.8390, -0.7883, -0.7853, -0.7886, -0.7877, -0.7873, -0.7877, -0.8268, -0.8468, -0.7346, -0.7592, -0.6595, -0.6277, -0.8040, -0.9767, -0.8186, -0.8140, -0.8304, -0.8015, -0.8108}, {-0.8005, -0.8014, -0.8437, -0.8379, -0.8408, -0.8829, -0.8047, -0.7915, -0.7420, -0.7636, -0.7375, -0.8561, -0.8677, -0.7907, -0.7780, -0.7878, -0.7819, -0.7827, -0.7940, -0.8620, -0.8702, -0.7671, -0.7571, -0.6480, -0.6704, -0.7977, -0.9470, -0.8381, -0.8101, -0.8400, -0.8090, -0.8104}, {-0.8131, -0.8306, -0.8330, -0.8564, -0.8291, -0.8389, -0.8070, -0.7887, -0.5945, -0.6101, -0.7441, -0.7597, -0.8557, -0.8320, -0.7993, -0.7880, -0.7843, -0.7946, -0.8369, -0.9072, -0.8295, -0.8127, -0.7438, -0.6392, -0.6805, -0.7752, -0.9178, -0.8321, -0.8199, -0.8327, -0.8183, -0.8055}, {-0.8309, -0.8589, -0.8119, -0.8793, -0.8279, -0.8307, -0.8751, -0.7672, -0.5177, -0.4200, -0.6973, -0.7448, -0.7837, -0.8859, -0.8243, -0.7809, -0.8102, -0.8316, -0.8024, -0.7683, -0.7767, -0.8349, -0.7455, -0.6995, -0.7027, -0.7641, -0.8595, -0.8175, -0.8363, -0.8329, -0.8337, -0.7981}, {-0.8084, -0.8353, -0.8082, -0.8537, -0.8181, -0.8228, -0.9362, -0.8298, -0.4939, -0.2696, -0.2914, -0.6461, -0.6693, -0.6106, -0.5946, -0.6194, -0.7092, -0.6434, -0.5923, -0.6675, -0.8107, -0.7991, -0.7733, -0.7186, -0.6616, -0.8494, -0.8143, -0.7667, -0.8359, -0.8053, -0.8398, -0.8055}, {-0.8135, -0.7982, -0.8192, -0.8156, -0.8541, -0.8061, -0.8360, -0.8806, -0.6095, -0.1874, -0.1734, -0.3148, -0.6329, -0.6943, -0.6184, -0.6004, -0.5543, -0.5629, -0.6893, -0.7732, -0.7703, -0.7946, -0.7304, -0.7053, -0.6903, -0.8309, -0.8200, -0.7744, -0.8281, -0.7814, -0.8217, -0.8000}, {-0.8241, -0.8130, -0.8367, -0.8261, -0.8594, -0.8293, -0.7477, -0.9365, -0.7899, -0.2834, -0.1007, -0.0934, -0.0795, -0.2581, -0.4655, -0.6374, -0.7298, -0.7455, -0.6974, -0.6673, -0.7439, -0.6767, -0.7011, -0.6203, -0.8536, -0.8232, -0.7324, -0.8262, -0.8017, -0.8420, -0.7901, -0.8177}, {-0.7790, -0.8168, -0.8199, -0.8141, -0.8049, -0.8375, -0.8095, -0.7637, -0.9209, -0.7438, -0.2269, -0.0238, -0.3071, -0.1574, -0.0522, -0.0984, -0.3121, -0.3262, -0.4105, -0.5454, -0.5458, -0.6175, -0.6293, -0.8483, -0.8532, -0.7496, -0.8341, -0.8210, -0.7330, -0.8124, -0.7762, -0.7718}, {-0.8278, -0.8223, -0.8008, -0.8311, -0.8191, -0.8252, -0.8328, -0.7376, -0.7560, -0.9176, -0.7742, -0.3799,  0.0672, -0.0500, -0.2896, -0.4140, -0.3760, -0.4415, -0.4681, -0.5068, -0.6979, -0.7352, -0.9034, -0.8406, -0.7769, -0.7591, -0.8422, -0.7405, -0.8391, -0.7943, -0.8093, -0.7844}, {-0.7920, -0.7995, -0.8200, -0.8057, -0.8123, -0.8099, -0.8221, -0.8406, -0.7615, -0.6898, -0.8764, -0.7813, -0.7989, -0.6972, -0.5929, -0.5987, -0.6646, -0.7008, -0.7279, -0.8127, -0.9090, -0.9110, -0.8129, -0.7917, -0.7657, -0.8719, -0.7869, -0.8242, -0.7895, -0.8029, -0.7585, -0.8183}, {-0.8135, -0.8101, -0.7956, -0.8180, -0.8039, -0.8190, -0.7945, -0.8118, -0.8487, -0.8015, -0.6564, -0.7849, -0.8295, -0.7274, -0.7264, -0.7740, -0.8273, -0.9051, -0.8748, -0.8386, -0.7730, -0.7580, -0.7501, -0.8415, -0.8562, -0.7683, -0.8107, -0.7887, -0.7791, -0.8026, -0.8235, -0.7756}, {-0.8086, -0.8046, -0.8201, -0.7978, -0.8187, -0.7978, -0.8140, -0.7942, -0.7650, -0.8267, -0.7966, -0.7765, -0.6163, -0.5865, -0.6954, -0.7048, -0.7089, -0.7048, -0.7479, -0.7489, -0.7787, -0.8565, -0.9024, -0.7984, -0.7928, -0.8549, -0.7902, -0.8065, -0.8040, -0.7982, -0.7813, -0.8184}, {-0.7917, -0.8254, -0.8051, -0.8009, -0.7953, -0.8223, -0.7979, -0.8245, -0.8311, -0.7167, -0.7580, -0.8392, -0.8277, -0.8317, -0.8187, -0.8196, -0.7786, -0.7943, -0.8127, -0.8696, -0.8477, -0.7800, -0.7824, -0.8224, -0.8583, -0.7739, -0.8084, -0.7977, -0.8027, -0.8053, -0.8315, -0.7789}, {-0.8033, -0.7973, -0.7990, -0.8018, -0.8189, -0.7986, -0.8190, -0.7869, -0.7971, -0.7914, -0.8465, -0.7607, -0.7559, -0.8190, -0.8306, -0.8366, -0.8218, -0.7771, -0.7671, -0.7872, -0.8016, -0.8125, -0.8363, -0.8050, -0.8006, -0.8201, -0.7876, -0.8183, -0.8138, -0.8108, -0.7723, -0.8069}, {-0.8041, -0.7940, -0.7937, -0.8135, -0.7814, -0.8012, -0.7960, -0.7646, -0.8103, -0.7578, -0.8184, -0.8225, -0.8406, -0.8418, -0.8297, -0.8145, -0.8253, -0.7973, -0.8039, -0.8487, -0.8249, -0.7927, -0.8095, -0.8165, -0.8182, -0.7769, -0.8278, -0.7924, -0.8328, -0.7840, -0.7951, -0.7940}, {-0.7905, -0.7908, -0.8095, -0.7913, -0.7814, -0.7897, -0.8171, -0.7940, -0.7847, -0.7570, -0.8211, -0.8061, -0.8039, -0.8029, -0.8034, -0.8068, -0.8065, -0.7932, -0.7759, -0.7919, -0.8146, -0.8295, -0.7983, -0.7962, -0.8183, -0.7969, -0.8072, -0.8254, -0.7893, -0.7987, -0.8039, -0.7771}}}};

    const char* model_path = argv[1];

    load_model(model_path);
    float* output = run_model(inputs);

    for (int i = 0; i < OUTPUT_PIXEL_SIZE; i++) {
        printf("%f\n", *(output + i));
    }

    struct timeval start, end;
    gettimeofday(&start, NULL);

    int iterations = 5000;
    printf("Running %d iterations to test speed\n", iterations);
    for (int i = 0; i < iterations; i++) {
        run_model(inputs);
    }

    gettimeofday(&end, NULL);
    double total_time = end.tv_sec + end.tv_usec / 1e6 - start.tv_sec - start.tv_usec / 1e6;

    printf("Total time for %d iterations: %f seconds\n", iterations, total_time);
    printf("Average time per iteration: %f seconds\n", total_time / iterations);

    // Proper output:
    //  1.0341
    //  0.66958
    //  1.031
    // -0.83508
    //  0.53434
    //  0.39728
    // -0.9179
    // -0.48178
    //  0.21093
    // -0.00046546
    //  0.22018
    //  0.94071
    // -0.68948
    //  0.17338
    //  0.17838
    //  0.26740
    // -0.59733
    // -0.12139
    //  0.18144
    //  0.47307
    // -0.016768
    //  0.35732
    //  0.23316
}
